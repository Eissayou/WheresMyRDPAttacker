<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Azure Honeypot Threat Map - SOC Dashboard</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        /* SVG Icons */
        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .icon-lg {
            width: 20px;
            height: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #00ff00;
            overflow: hidden;
        }

        /* Mobile Toggle Button */
        #mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffff, #0088ff);
            border: 3px solid #fff;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.6);
            z-index: 2000;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #mobile-toggle:active {
            transform: scale(0.9);
        }

        #mobile-toggle svg {
            width: 28px;
            height: 28px;
            stroke: #000;
            stroke-width: 2.5;
            fill: none;
        }

        /* Mobile Panels Container */
        #mobile-panels-wrapper {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1999;
            overflow-y: auto;
            padding: 60px 15px 80px;
            animation: fadeIn 0.2s;
        }

        #mobile-panels-wrapper.visible {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #mobile-toggle {
                display: flex;
            }

            /* Hide desktop panels */
            .hud-panel {
                display: none;
            }

            /* Show panels in mobile wrapper */
            #mobile-panels-wrapper .hud-panel {
                display: block;
                position: static;
                width: 100%;
                margin-bottom: 15px;
                font-size: 12px;
                padding: 12px;
            }

            #mobile-panels-wrapper .hud-panel h2 {
                font-size: 14px;
            }

            #username-modal-content {
                max-width: 90%;
                padding: 15px;
            }
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* HUD Panel Base Styles */
        .hud-panel {
            position: absolute;
            background: rgba(0, 20, 40, 0.85);
            border: 2px solid #00ffff;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .hud-panel h2 {
            color: #00ffff;
            font-size: 18px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #00ffff;
            padding-bottom: 5px;
        }

        /* Leaderboard Panel (Top Left) */
        #stats-panel {
            top: 90px;
            /* Moved down to avoid zoom controls */
            left: 20px;
            width: 340px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 50, 100, 0.3);
            border-left: 3px solid #00ffff;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .leaderboard-item:hover {
            background: rgba(0, 50, 100, 0.5);
            border-left-width: 5px;
        }

        .leaderboard-rank {
            font-size: 18px;
            font-weight: bold;
            color: #00ffff;
            min-width: 30px;
        }

        .leaderboard-country {
            flex: 1;
            color: #00ff00;
            font-size: 14px;
            margin: 0 10px;
        }

        .leaderboard-count {
            color: #ff6666;
            font-weight: bold;
            font-size: 16px;
            min-width: 60px;
            text-align: right;
        }

        .leaderboard-bar {
            height: 4px;
            background: linear-gradient(90deg, #ff0000, #ff6666);
            margin-top: 4px;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .update-time {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 255, 255, 0.3);
            font-size: 11px;
            color: #888;
            text-align: center;
        }

        .update-time-value {
            color: #00ffff;
            font-weight: bold;
        }

        /* Target Info Panel (Top Right) */
        #target-panel {
            top: 20px;
            right: 20px;
            width: 280px;
        }

        /* Username Leaderboard Panel (Middle Right) */
        #username-panel {
            top: 240px;
            right: 20px;
            width: 280px;
        }

        .username-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 6px 0;
            padding: 6px 8px;
            background: rgba(50, 0, 100, 0.3);
            border-left: 3px solid #ff00ff;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .username-item {
            cursor: pointer;
        }

        .username-item:hover {
            background: rgba(50, 0, 100, 0.5);
            border-left-width: 5px;
            transform: translateX(3px);
        }

        .username-name {
            color: #ff00ff;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .username-count {
            color: #ffaa00;
            font-weight: bold;
        }

        #target-panel p {
            color: #00ff00;
            font-size: 14px;
            margin: 5px 0;
        }

        .target-label {
            color: #00ffff;
            font-weight: bold;
        }

        /* History Controls (Bottom Right) */
        #history-panel {
            bottom: 20px;
            right: 20px;
            width: 320px;
        }

        #date-picker {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: rgba(0, 50, 100, 0.8);
            border: 1px solid #00ffff;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            cursor: pointer;
        }

        #date-picker::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .mode-indicator {
            display: inline-block;
            padding: 3px 8px;
            background: #00ff00;
            color: #000;
            font-size: 11px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
        }

        .mode-indicator.live {
            background: #00ff00;
            animation: pulse 2s infinite;
        }

        .mode-indicator.history {
            background: #ffaa00;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Error Message */
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 0, 0, 0.9);
            color: #fff;
            padding: 20px 40px;
            border: 2px solid #ff0000;
            border-radius: 8px;
            z-index: 2000;
            display: none;
            text-align: center;
        }

        #error-message h3 {
            margin-bottom: 10px;
            color: #ff6666;
        }

        /* Username Detail Modal */
        #username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #username-modal-content {
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #ff00ff;
            border-radius: 8px;
            padding: 25px;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }

        #username-modal h3 {
            color: #ff00ff;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #ff00ff;
            padding-bottom: 10px;
        }

        .username-detail-item {
            background: rgba(0, 50, 100, 0.3);
            border-left: 3px solid #00ffff;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
        }

        .username-detail-item .ip {
            color: #ff6666;
            font-weight: bold;
            font-size: 14px;
        }

        .username-detail-item .location {
            color: #00ff00;
            font-size: 13px;
        }

        .username-detail-item .attempts {
            color: #ffaa00;
            font-size: 13px;
        }

        #username-modal-close {
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(255, 0, 255, 0.2);
            border: 1px solid #ff00ff;
            color: #ff00ff;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            width: 100%;
            transition: all 0.3s;
        }

        #username-modal-close:hover {
            background: rgba(255, 0, 255, 0.4);
        }

        #username-modal-content::-webkit-scrollbar {
            width: 8px;
        }

        #username-modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }

        #username-modal-content::-webkit-scrollbar-thumb {
            background: #ff00ff;
            border-radius: 4px;
        }

        /* Loading Indicator */
        .loading {
            color: #00ffff;
            font-style: italic;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50%,
            100% {
                opacity: 1;
            }

            25%,
            75% {
                opacity: 0.5;
            }
        }

        /* Scrollbar Styling */
        #attack-feed::-webkit-scrollbar {
            width: 8px;
        }

        #attack-feed::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }

        #attack-feed::-webkit-scrollbar-thumb {
            background: #00ffff;
            border-radius: 4px;
        }

        /* Auto-refresh Countdown */
        .auto-refresh {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-refresh strong {
            color: #00ffff;
            font-weight: bold;
        }

        @keyframes markerGlow {
            0% {
                opacity: 0;
                filter: drop-shadow(0 0 0px currentColor);
            }

            50% {
                opacity: 0.8;
                filter: drop-shadow(0 0 20px currentColor);
            }

            100% {
                opacity: 1;
                filter: drop-shadow(0 0 8px currentColor);
            }
        }

        .attack-marker {
            animation: markerGlow 0.8s ease-out;
            filter: drop-shadow(0 0 8px currentColor);
            transform-box: fill-box;
            transform-origin: center;
            will-change: transform, opacity, filter;
        }

        /* Custom Cluster Styles */
        .marker-cluster-small {
            background-color: rgba(0, 255, 0, 0.6);
        }

        .marker-cluster-small div {
            background-color: rgba(0, 255, 0, 0.8);
        }

        .marker-cluster-medium {
            background-color: rgba(255, 170, 0, 0.6);
        }

        .marker-cluster-medium div {
            background-color: rgba(255, 170, 0, 0.8);
        }

        .marker-cluster-large {
            background-color: rgba(255, 0, 0, 0.6);
        }

        .marker-cluster-large div {
            background-color: rgba(255, 0, 0, 0.8);
        }

        .marker-cluster {
            border: 2px solid #fff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font: 12px "Courier New", monospace;
            font-weight: bold;
            color: #000;
            line-height: 30px;
        }

        /* AI Analysis Panel (Bottom Left) */
        #ai-panel {
            bottom: 20px;
            left: 20px;
            width: 380px;
            max-height: 500px;
            overflow-y: auto;
        }

        .ai-date-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .ai-date-row input[type="date"] {
            flex: 1;
            padding: 8px;
            background: rgba(0, 50, 100, 0.8);
            border: 1px solid #00ffff;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            cursor: pointer;
        }

        .ai-date-row input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .ai-date-row span {
            color: #00ffff;
            font-weight: bold;
        }

        #ai-compare-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #ai-compare-btn:hover {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        #ai-compare-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* AI Modal */
        #ai-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #ai-modal-content {
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #6366f1;
            border-radius: 8px;
            padding: 25px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            display: flex;
            flex-direction: column;
        }

        #ai-modal h3 {
            color: #a78bfa;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            /* Align inputs and VS text */
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(0, 50, 100, 0.3);
            padding: 20px;
            border-radius: 6px;
        }

        .ai-date-group {
            flex: 1;
            min-width: 140px;
            /* Ensure inputs don't get too small */
        }

        .ai-controls input[type="date"] {
            padding: 10px;
            background: rgba(0, 50, 100, 0.8);
            border: 1px solid #6366f1;
            color: #fff;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            width: 100%;
        }

        .ai-vs {
            color: #6366f1;
            font-weight: bold;
            font-size: 18px;
            padding-bottom: 8px;
            /* Visual alignment with inputs */
        }

        #ai-compare-btn {
            width: 100%;
            /* Force button to new line/full width */
            flex-basis: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #ai-results-area {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 6px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #e0e0e0;
        }

        #ai-results-area h1,
        #ai-results-area h2,
        #ai-results-area h3 {
            color: #a78bfa;
            margin: 15px 0 10px;
        }

        #ai-results-area ul {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        #ai-results-area li {
            margin-bottom: 5px;
        }

        #ai-results-area strong {
            color: #00ffff;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #666;
            color: #ccc;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        .btn-secondary:hover {
            border-color: #fff;
            color: #fff;
        }



        .ai-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #a78bfa;
        }

        .ai-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #6366f1;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .ai-error {
            color: #ff6666;
            padding: 10px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <!-- Main Map -->
    <div id="map"></div>

    <!-- Mobile Toggle Button -->
    <button id="mobile-toggle" type="button" aria-label="Toggle Dashboard">
        <svg viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="7" rx="1" />
            <rect x="14" y="3" width="7" height="7" rx="1" />
            <rect x="3" y="14" width="7" height="7" rx="1" />
            <rect x="14" y="14" width="7" height="7" rx="1" />
        </svg>
    </button>

    <!-- Mobile Panels Wrapper -->
    <div id="mobile-panels-wrapper"></div>

    <!-- Leaderboard Panel (Top Left) -->
    <div class="hud-panel" id="stats-panel">
        <h2>
            <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18" />
                <path d="M18 17V9" />
                <path d="M13 17V5" />
                <path d="M8 17v-3" />
            </svg>
            Top Attacking Countries
            <span class="mode-indicator live" id="mode-indicator">LIVE</span>
        </h2>
        <div id="leaderboard-container">
            <p class="loading">Loading leaderboard...</p>
        </div>
        <div class="auto-refresh" id="auto-refresh-row">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-3-6.7" />
                <path d="M21 3v7h-7" />
            </svg>
            Next auto-refresh in <strong id="auto-refresh-countdown">--:--</strong>
        </div>
        <div class="update-time">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 6v6l4 2" />
            </svg>
            Last Updated: <span class="update-time-value" id="last-update">--:--:--</span>
        </div>
    </div>

    <!-- Target Info Panel (Top Right) -->
    <div class="hud-panel" id="target-panel">
        <h2>
            <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <circle cx="12" cy="12" r="6" />
                <circle cx="12" cy="12" r="2" />
            </svg>
            Target Information
        </h2>
        <p><span class="target-label">Asset:</span> Azure VM (Honeypot)</p>
        <p><span class="target-label">Public IP:</span> 4.154.169.43</p>
        <p><span class="target-label">Service:</span> RDP (Port 3389)</p>
        <p><span class="target-label">Location:</span> Azure Cloud</p>
        <p><span class="target-label">Status:</span> <span style="color: #00ff00;">● MONITORING</span></p>
    </div>

    <!-- Username Leaderboard Panel (Middle Right) -->
    <div class="hud-panel" id="username-panel">
        <h2>
            <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" />
                <path d="M12 14c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z" />
            </svg>
            Top Usernames Tried
        </h2>
        <div id="username-container">
            <p class="loading">Loading usernames...</p>
        </div>
    </div>

    <!-- History Controls (Bottom Right) -->
    <div class="hud-panel" id="history-panel">
        <h2>
            <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            Historical Data
        </h2>
        <label for="date-picker" style="color: #888; font-size: 12px;">Select Date:</label>
        <input type="date" id="date-picker" max="">
    </div>

    <!-- AI Analysis Panel (Bottom Left - Minimized) -->
    <div class="hud-panel" id="ai-panel">
        <h2>
            <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z" />
                <path d="M16 14v2a4 4 0 0 1-8 0v-2" />
                <circle cx="12" cy="18" r="2" />
                <path d="M9 22h6" />
                <path d="M12 2v-1" />
                <path d="M4 6h1" />
                <path d="M19 6h1" />
            </svg>
            AI Trend Analysis
        </h2>
        <p style="color: #ccc; font-size: 12px; margin-bottom: 10px;">
            Analyze attack patterns and generate insights using Gemini AI.
        </p>
        <button id="ai-panel-open-btn"
            style="width: 100%; padding: 10px; background: rgba(99, 102, 241, 0.2); border: 1px solid #6366f1; color: #a78bfa; border-radius: 4px; cursor: pointer; font-family: 'Courier New'; font-weight: bold; transition: all 0.3s;">
            Open Analysis Tool
        </button>
    </div>

    <!-- AI Analysis Modal (Full) -->
    <div id="ai-modal">
        <div id="ai-modal-content">
            <h3>
                <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z" />
                    <path d="M16 14v2a4 4 0 0 1-8 0v-2" />
                    <circle cx="12" cy="18" r="2" />
                    <path d="M9 22h6" />
                </svg>
                AI Attack Pattern Analysis
            </h3>

            <div class="ai-controls">
                <div class="ai-date-group">
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 12px;">Baseline
                        Date</label>
                    <input type="date" id="ai-date1">
                </div>
                <div class="ai-vs">VS</div>
                <div class="ai-date-group">
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 12px;">Comparison
                        Date</label>
                    <input type="date" id="ai-date2">
                </div>
                <button id="ai-compare-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    Analyze
                </button>
            </div>

            <div id="ai-results-area">
                <div
                    style="display: flex; height: 100%; align-items: center; justify-content: center; color: #666; font-style: italic;">
                    Select dates and click Analyze to generate insights.
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn-secondary" id="ai-modal-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-message">
        <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            style="display: block; margin: 0 auto 10px;">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
        </svg>
        <h3>No Data Available</h3>
        <p id="error-text"></p>
    </div>

    <!-- Username Detail Modal -->
    <div id="username-modal">
        <div id="username-modal-content">
            <h3 id="username-modal-title">IPs that tried username</h3>
            <div id="username-modal-list"></div>
            <button id="username-modal-close" type="button">Close</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        // ⚠️ REPLACE WITH YOUR AZURE STORAGE ACCOUNT NAME
        const STORAGE_ACCOUNT = 'honeypotpublicdata'; // e.g., 'myhoneypotdata'
        const BLOB_CONTAINER = 'public-data';
        const BLOB_BASE_URL = `https://${STORAGE_ACCOUNT}.blob.core.windows.net/${BLOB_CONTAINER}`;

        const AUTO_REFRESH_INTERVAL = 30 * 60 * 1000; // 30 minutes (matches Logic App)
        const AUTO_REFRESH_BUFFER_MS = 2 * 60 * 1000; // UI buffer to allow blob/pipeline delay

        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let map;
        let markers = [];
        let markerClusterGroup;
        let attackData = [];
        let isLiveMode = true;
        let autoRefreshTimer;
        let autoRefreshCountdownTimer;
        let nextAutoRefreshAt;

        function toCount(value) {
            if (value == null) return 0;
            if (typeof value === 'number') return Number.isFinite(value) ? value : 0;
            if (typeof value === 'string') {
                const cleaned = value.replace(/,/g, '').trim();
                const parsed = Number(cleaned);
                return Number.isFinite(parsed) ? parsed : 0;
            }
            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        // ========================================
        // INITIALIZE MAP
        // ========================================
        function initMap() {
            map = L.map('map', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2,
                maxZoom: 18,
                worldCopyJump: true,
                maxBounds: L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180)),
                maxBoundsViscosity: 1.0
            });

            // Dark theme basemap (CartoDB Dark Matter)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Initialize marker cluster group
            markerClusterGroup = L.markerClusterGroup({
                spiderfyOnMaxZoom: true,         // Enable spider when fully zoomed (shows stacked markers)
                showCoverageOnHover: false,      // Cleaner hover (no blue overlay)
                zoomToBoundsOnClick: true,       // Zoom in when clicking cluster
                maxClusterRadius: 60,            // Tighter clustering for cleaner look
                disableClusteringAtZoom: 12,     // Stop clustering at city-level zoom
                spiderfyDistanceMultiplier: 2,   // Larger spread for easier clicking
                spiderfyDistanceSurplus: 40,     // Extra distance between markers
                spiderLegPolylineOptions: {      // Make spider legs more visible
                    weight: 2,
                    color: '#00ffff',
                    opacity: 0.6
                },
                animate: true,                   // Smooth animations
                animateAddingMarkers: false,     // Disable to avoid errors with circle markers
                iconCreateFunction: function (cluster) {
                    const childCount = cluster.getChildCount();
                    let c = ' marker-cluster-';
                    if (childCount < 10) {
                        c += 'small';
                    } else if (childCount < 50) {
                        c += 'medium';
                    } else {
                        c += 'large';
                    }
                    return new L.DivIcon({
                        html: '<div><span>' + childCount + '</span></div>',
                        className: 'marker-cluster' + c,
                        iconSize: new L.Point(40, 40)
                    });
                }
            });
            map.addLayer(markerClusterGroup);
        }

        // ========================================
        // FETCH ATTACK DATA
        // ========================================
        async function fetchAttackData(date = null) {
            const targetDate = date || getTodayDate();
            const fileName = `attacks_${targetDate}.json`;
            // Cache-bust so the dashboard reliably updates after new blobs are written
            const url = `${BLOB_BASE_URL}/${fileName}?v=${Date.now()}`;

            console.log(`Fetching: ${url}`);

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`No attack data found for ${targetDate}`);
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error(`No attacks recorded for ${targetDate}`);
                }

                attackData = data;
                updateDashboard();
                hideError();

            } catch (error) {
                console.error('Fetch error:', error);
                showError(error.message);
                clearDashboard();
            }
        }

        // ========================================
        // UPDATE DASHBOARD
        // ========================================
        function updateDashboard() {
            clearMarkers();
            updateLeaderboard();
            updateUsernameLeaderboard();
            plotMarkers();
            updateLastUpdateTime();
        }

        // ========================================
        // PLOT MARKERS ON MAP
        // ========================================
        function plotMarkers() {
            attackData.forEach(attack => {
                const lat = (attack.lat ?? (attack.Latitude != null ? parseFloat(attack.Latitude) : NaN));
                const lon = (attack.lon ?? (attack.Longitude != null ? parseFloat(attack.Longitude) : NaN));

                if (isNaN(lat) || isNaN(lon)) {
                    return; // Skip invalid coordinates
                }

                const attackCount = toCount(attack.attack_count ?? attack.FailureCount);

                // Marker color based on failure count
                let markerColor = '#00ff00'; // Green (low)
                if (attackCount > 50) {
                    markerColor = '#ff0000'; // Red (high)
                } else if (attackCount > 20) {
                    markerColor = '#ff6600'; // Orange (medium)
                } else if (attackCount > 5) {
                    markerColor = '#ffaa00'; // Yellow (low-medium)
                }

                const marker = L.circleMarker([lat, lon], {
                    radius: Math.min(5 + (attackCount / 5), 20),
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8,
                    className: 'attack-marker'
                });

                // Ensure CSS glow uses the marker's own severity color (currentColor)
                marker.on('add', () => {
                    const el = marker.getElement ? marker.getElement() : marker._path;
                    if (el) {
                        el.style.color = markerColor;
                    }
                });

                // Popup with attack details
                const ip = attack.ip || attack.IpAddress;
                const city = attack.city || attack.City || 'Unknown';
                const state = attack.state || attack.State || '';
                const country = attack.country || attack.Country || 'Unknown';
                const firstSeen = attack.first_seen ? formatTimestamp(attack.first_seen) : 'N/A';
                const lastSeen = attack.last_seen || attack.timestamp;

                // Parse target_accounts (may be JSON string from KQL)
                let accounts = attack.target_accounts;
                if (typeof accounts === 'string') {
                    try {
                        accounts = JSON.parse(accounts);
                    } catch (e) {
                        accounts = [];
                    }
                }
                const accountsDisplay = (accounts && Array.isArray(accounts))
                    ? accounts.slice(0, 5).map(a => {
                        const parts = a.split('\\');
                        return parts[parts.length - 1];
                    }).join(', ')
                    : 'N/A';

                const popupContent = `
                    <div style="font-family: 'Courier New', monospace; color: #000;">
                        <strong style="color: #ff0000;">ATTACK DETECTED</strong><br>
                        <strong>IP:</strong> ${ip}<br>
                        <strong>Location:</strong> ${city}${state ? ', ' + state : ''}, ${country}<br>
                        <strong>Failed Attempts:</strong> ${attackCount}<br>
                        <strong>First Seen:</strong> ${firstSeen}<br>
                        <strong>Last Seen:</strong> ${formatTimestamp(lastSeen)}<br>
                        <strong>Usernames Tried:</strong> ${accountsDisplay}
                    </div>
                `;
                marker.bindPopup(popupContent);

                markers.push(marker);
                markerClusterGroup.addLayer(marker);
            });
        }

        // ========================================
        // UPDATE LEADERBOARD PANEL
        // ========================================
        function updateLeaderboard() {
            // Update ALL leaderboard containers (desktop + mobile clone)
            const leaderboardContainers = document.querySelectorAll('#leaderboard-container');

            // Aggregate attacks by country
            const countryCount = {};
            attackData.forEach(attack => {
                const country = attack.country || attack.Country || 'Unknown';
                const count = toCount(attack.attack_count ?? attack.FailureCount);
                countryCount[country] = (countryCount[country] || 0) + count;
            });

            // Get top 5 countries
            const topCountries = Object.entries(countryCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (topCountries.length === 0) {
                leaderboardContainers.forEach(container => {
                    container.innerHTML = '<p class="loading">No data available</p>';
                });
                return;
            }

            const maxCount = topCountries[0][1] || 1;

            leaderboardContainers.forEach(leaderboardContainer => {
                leaderboardContainer.innerHTML = '';

                topCountries.forEach(([country, count], index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';

                    const barWidth = (count / maxCount) * 100;

                    item.innerHTML = `
                        <span class="leaderboard-rank">#${index + 1}</span>
                        <div class="leaderboard-country">
                            ${country}
                            <div class="leaderboard-bar" style="width: ${barWidth}%"></div>
                        </div>
                        <span class="leaderboard-count">${count.toLocaleString()}</span>
                    `;

                    leaderboardContainer.appendChild(item);
                });
            });
        }

        // ========================================
        // UPDATE USERNAME LEADERBOARD
        // ========================================
        function updateUsernameLeaderboard() {
            // Update ALL username containers (desktop + mobile clone)
            const usernameContainers = document.querySelectorAll('#username-container');

            // Count how many unique IPs tried each username
            // This is the clearest metric: "Which usernames are attackers targeting?"
            const usernameIPs = {}; // username -> Set of IPs

            attackData.forEach(attack => {
                const ip = attack.ip || attack.IpAddress || 'unknown';
                let accounts = attack.target_accounts;

                // Handle both string (from KQL make_set) and array formats
                if (typeof accounts === 'string') {
                    try {
                        accounts = JSON.parse(accounts);
                    } catch (e) {
                        accounts = [];
                    }
                }

                if (accounts && Array.isArray(accounts)) {
                    // Get unique cleaned usernames for this IP
                    const seenUsernames = new Set();
                    accounts.forEach(username => {
                        if (username) {
                            const parts = String(username).split(/\\+/);
                            const cleanUsername = parts[parts.length - 1].toUpperCase().trim();
                            if (cleanUsername && !seenUsernames.has(cleanUsername)) {
                                seenUsernames.add(cleanUsername);
                                if (!usernameIPs[cleanUsername]) {
                                    usernameIPs[cleanUsername] = new Set();
                                }
                                usernameIPs[cleanUsername].add(ip);
                            }
                        }
                    });
                }
            });

            // Get top 5 usernames by number of unique IPs that tried them
            const topUsernames = Object.entries(usernameIPs)
                .map(([username, ips]) => [username, ips.size])
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (topUsernames.length === 0) {
                usernameContainers.forEach(container => {
                    container.innerHTML = '<p class="loading">No usernames detected</p>';
                });
                return;
            }

            usernameContainers.forEach(usernameContainer => {
                usernameContainer.innerHTML = '';

                topUsernames.forEach(([username, ipCount]) => {
                    const item = document.createElement('div');
                    item.className = 'username-item';
                    item.innerHTML = `
                        <span class="username-name">${username}</span>
                        <span class="username-count">${ipCount} IPs</span>
                    `;

                    // Make it clickable to show IPs that tried this username
                    item.addEventListener('click', () => showUsernameDetail(username));

                    usernameContainer.appendChild(item);
                });
            });
        }

        // ========================================
        // SHOW USERNAME DETAIL MODAL
        // ========================================
        function showUsernameDetail(username) {
            const modal = document.getElementById('username-modal');
            const title = document.getElementById('username-modal-title');
            const list = document.getElementById('username-modal-list');

            title.textContent = `IPs that tried "${username}"`;
            list.innerHTML = '';

            // Find all IPs that tried this username with distributed counts
            const matchingAttacks = [];
            attackData.forEach(attack => {
                let accounts = attack.target_accounts;

                if (typeof accounts === 'string') {
                    try {
                        accounts = JSON.parse(accounts);
                    } catch (e) {
                        accounts = [];
                    }
                }

                if (accounts && Array.isArray(accounts) && accounts.length > 0) {
                    const hasUsername = accounts.some(acc => {
                        // Handle both single and double backslashes, and clean whitespace
                        const parts = String(acc).split(/\\+/);
                        const cleanName = parts[parts.length - 1].toUpperCase().trim();
                        return cleanName === username;
                    });

                    if (hasUsername) {
                        matchingAttacks.push(attack);
                    }
                }
            });

            // Sort by full attack count
            matchingAttacks.sort((a, b) => {
                const countA = toCount(a.attack_count ?? a.FailureCount);
                const countB = toCount(b.attack_count ?? b.FailureCount);
                return countB - countA;
            });

            if (matchingAttacks.length === 0) {
                list.innerHTML = '<p style="color: #888;">No IPs found</p>';
            } else {
                matchingAttacks.forEach(attack => {
                    const ip = attack.ip || attack.IpAddress || 'Unknown';
                    const city = attack.city || attack.City || 'Unknown';
                    const country = attack.country || attack.Country || 'Unknown';
                    const count = toCount(attack.attack_count ?? attack.FailureCount);

                    const item = document.createElement('div');
                    item.className = 'username-detail-item';
                    item.innerHTML = `
                        <div class="ip">${ip}</div>
                        <div class="location">${city}, ${country}</div>
                        <div class="attempts">${count.toLocaleString()} total attacks</div>
                    `;
                    list.appendChild(item);
                });
            }

            modal.style.display = 'flex';
        }

        function closeUsernameModal() {
            document.getElementById('username-modal').style.display = 'none';
        }

        // ========================================
        // CLEAR MARKERS
        // ========================================
        function clearMarkers() {
            markerClusterGroup.clearLayers();
            markers = [];
        }

        // ========================================
        // CLEAR DASHBOARD
        // ========================================
        function clearDashboard() {
            clearMarkers();
            // Update all containers (desktop + mobile)
            document.querySelectorAll('#leaderboard-container').forEach(container => {
                container.innerHTML = '<p class="loading">No data available</p>';
            });
            document.querySelectorAll('#username-container').forEach(container => {
                container.innerHTML = '<p class="loading">No data available</p>';
            });
        }

        // ========================================
        // ERROR HANDLING
        // ========================================
        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function getTodayDate() {
            // Get current date in Pacific Time (California)
            const now = new Date();
            const pacificTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
            const year = pacificTime.getFullYear();
            const month = String(pacificTime.getMonth() + 1).padStart(2, '0');
            const day = String(pacificTime.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            // Convert to Pacific Time
            return date.toLocaleString('en-US', {
                timeZone: 'America/Los_Angeles',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function updateLastUpdateTime() {
            const now = new Date();
            // Display in Pacific Time
            const timeStr = now.toLocaleTimeString('en-US', {
                timeZone: 'America/Los_Angeles',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            // Update ALL last-update elements (desktop + mobile)
            document.querySelectorAll('#last-update').forEach(element => {
                element.textContent = timeStr + ' PT';
            });
        }

        // ========================================
        // MODE SWITCHING
        // ========================================
        function switchToLiveMode() {
            isLiveMode = true;

            // Update ALL mode indicators (desktop + mobile)
            document.querySelectorAll('#mode-indicator').forEach(indicator => {
                indicator.textContent = 'LIVE';
                indicator.className = 'mode-indicator live';
            });

            // Set date picker to today
            const today = getTodayDate();
            document.querySelectorAll('#date-picker').forEach(picker => {
                picker.value = today;
            });

            fetchAttackData();
            startAutoRefresh();
        }

        function switchToHistoryMode(date) {
            isLiveMode = false;

            // Update ALL mode indicators (desktop + mobile)
            document.querySelectorAll('#mode-indicator').forEach(indicator => {
                indicator.textContent = 'HISTORY';
                indicator.className = 'mode-indicator history';
            });

            // Set date picker to selected date
            document.querySelectorAll('#date-picker').forEach(picker => {
                picker.value = date;
            });

            stopAutoRefresh();
            fetchAttackData(date);
        }

        // ========================================
        // AUTO REFRESH
        // ========================================
        function getNextScheduledRefreshTime() {
            // Logic App runs every 30 minutes (on the hour and half-hour in Pacific Time)
            // Calculate next :00 or :30 mark in Pacific Time
            const now = new Date();
            const pacificTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));

            const currentMinute = pacificTime.getMinutes();
            const currentSecond = pacificTime.getSeconds();

            let minutesUntilNext;
            if (currentMinute < 30) {
                // Next refresh at :30
                minutesUntilNext = 30 - currentMinute;
            } else {
                // Next refresh at next hour :00
                minutesUntilNext = 60 - currentMinute;
            }

            // Subtract current seconds to get exact time
            const secondsUntilNext = (minutesUntilNext * 60) - currentSecond;

            return Date.now() + (secondsUntilNext * 1000);
        }

        function startAutoRefresh() {
            stopAutoRefresh(); // Clear existing timer

            // Calculate next scheduled refresh time (synced to :00 and :30)
            nextAutoRefreshAt = getNextScheduledRefreshTime();
            startAutoRefreshCountdown();

            // Check every minute if we've passed the scheduled time
            autoRefreshTimer = setInterval(() => {
                if (isLiveMode && Date.now() >= nextAutoRefreshAt) {
                    console.log('Auto-refreshing data...');
                    fetchAttackData();
                    // Calculate next scheduled time after this refresh
                    nextAutoRefreshAt = getNextScheduledRefreshTime();
                }
            }, 60000); // Check every minute instead of waiting full 30 min
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }

            stopAutoRefreshCountdown();
        }

        function startAutoRefreshCountdown() {
            stopAutoRefreshCountdown();

            const render = () => {
                // Update ALL countdown elements (desktop + mobile)
                document.querySelectorAll('#auto-refresh-countdown').forEach(countdownEl => {
                    if (!isLiveMode) {
                        countdownEl.textContent = 'PAUSED';
                        return;
                    }

                    const remainingMs = Math.max(0, (nextAutoRefreshAt || Date.now()) - Date.now());
                    const remainingSec = Math.ceil(remainingMs / 1000);
                    const mm = String(Math.floor(remainingSec / 60)).padStart(2, '0');
                    const ss = String(remainingSec % 60).padStart(2, '0');
                    countdownEl.textContent = `${mm}:${ss}`;
                });
            };

            render();
            autoRefreshCountdownTimer = setInterval(render, 1000);
        }

        function stopAutoRefreshCountdown() {
            if (autoRefreshCountdownTimer) {
                clearInterval(autoRefreshCountdownTimer);
                autoRefreshCountdownTimer = null;
            }
        }

        // ========================================
        // MOBILE TOGGLE
        // ========================================
        function setupMobileToggle() {
            const toggle = document.getElementById('mobile-toggle');
            const wrapper = document.getElementById('mobile-panels-wrapper');
            const panels = document.querySelectorAll('.hud-panel');

            if (toggle && wrapper) {
                // Clone panels to mobile wrapper
                panels.forEach(panel => {
                    const clone = panel.cloneNode(true);

                    // Fix IDs in clone to avoid duplicates (optional but good practice)
                    // For now, we just rely on class selectors contextually

                    wrapper.appendChild(clone);

                    // Re-attach specific listeners for mobile clones

                    // 1. Mobile Date Picker
                    if (panel.id === 'history-panel') {
                        const mobileDatePicker = clone.querySelector('#date-picker');
                        if (mobileDatePicker) {
                            mobileDatePicker.addEventListener('change', handleDateChange);
                        }
                    }

                    // 2. Mobile AI Open Button
                    if (panel.id === 'ai-panel') {
                        const mobileAiOpenBtn = clone.querySelector('#ai-panel-open-btn');
                        if (mobileAiOpenBtn) {
                            mobileAiOpenBtn.addEventListener('click', () => {
                                // Close mobile menu first? Optional.
                                // wrapper.classList.remove('visible'); 
                                document.getElementById('ai-modal').style.display = 'flex';
                            });
                        }
                    }
                });

                // Toggle visibility
                toggle.addEventListener('click', () => {
                    wrapper.classList.toggle('visible');
                });

                // Close when clicking outside panels
                wrapper.addEventListener('click', (e) => {
                    if (e.target === wrapper) {
                        wrapper.classList.remove('visible');
                    }
                });
            }
        }

        function handleDateChange(e) {
            const selectedDate = e.target.value;
            if (selectedDate) {
                // Check if selected date is today
                const today = getTodayDate();
                if (selectedDate === today) {
                    switchToLiveMode();
                } else {
                    switchToHistoryMode(selectedDate);
                }
            } else {
                switchToLiveMode();
            }
        }

        // ========================================
        // AI COMPARISON
        // ========================================
        // ⚠️ REPLACE WITH YOUR AZURE FUNCTION URL AFTER DEPLOYMENT
        const AI_FUNCTION_URL = 'https://aianalysis-hmhudebecwhebrhv.westus2-01.azurewebsites.net/api/compare';

        async function fetchDataForDate(date) {
            const fileName = `attacks_${date}.json`;
            const url = `${BLOB_BASE_URL}/${fileName}?v=${Date.now()}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`No data for ${date}`);
            }
            return response.json();
        }

        async function compareWithAI() {
            const date1 = document.getElementById('ai-date1').value;
            const date2 = document.getElementById('ai-date2').value;
            const btn = document.getElementById('ai-compare-btn');
            const resultsArea = document.getElementById('ai-results-area');

            if (!date1 || !date2) {
                alert('Please select both dates');
                return;
            }

            if (date1 === date2) {
                alert('Please select two different dates');
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<div class="ai-spinner"></div>';
            resultsArea.innerHTML = `
                <div class="ai-loading" style="justify-content: center; height: 100%; flex-direction: column;">
                    <div class="ai-spinner" style="width: 40px; height: 40px; border-width: 4px; margin-bottom: 15px;"></div>
                    <div style="color: #a78bfa; font-size: 16px;">Analyzing attack telemetry...</div>
                </div>
            `;

            try {
                // Fetch data for both dates
                const [data1, data2] = await Promise.all([
                    fetchDataForDate(date1),
                    fetchDataForDate(date2)
                ]);

                // Call Azure Function
                const response = await fetch(AI_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date1, date2, data1, data2 })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Analysis failed');
                }

                const result = await response.json();

                // Helper to safely display any value (handles objects/arrays)
                const safeDisplay = (val, fallback = 'No data.') => {
                    if (!val) return fallback;
                    if (typeof val === 'string') return val;
                    if (typeof val === 'object') return JSON.stringify(val, null, 2);
                    return String(val);
                };

                // Format structured JSON output
                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-left: 4px solid #6366f1; border-radius: 4px;">
                        <h4 style="margin: 0 0 5px 0; color: #a78bfa; text-transform: uppercase; font-size: 12px;">Executive Summary</h4>
                        <p style="margin: 0; color: #fff; font-size: 15px; font-weight: 500;">${safeDisplay(result.summary, 'Analysis complete.')}</p>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h4 style="color: #00ffff; margin-bottom: 8px; border-bottom: 1px solid rgba(0,255,255,0.2); padding-bottom: 4px;">Attack Volume</h4>
                            <p>${safeDisplay(result.attack_volume, 'No significant changes.')}</p>
                        </div>

                        <div>
                            <h4 style="color: #00ffff; margin-bottom: 8px; border-bottom: 1px solid rgba(0,255,255,0.2); padding-bottom: 4px;">Geographic Shifts</h4>
                            <p>${safeDisplay(result.geographic_shifts, 'No significant changes.')}</p>
                        </div>

                        <div>
                            <h4 style="color: #00ffff; margin-bottom: 8px; border-bottom: 1px solid rgba(0,255,255,0.2); padding-bottom: 4px;">Notable IPs</h4>
                            <p>${safeDisplay(result.notable_ips, 'None detected.')}</p>
                        </div>

                        <div>
                            <h4 style="color: #00ffff; margin-bottom: 8px; border-bottom: 1px solid rgba(0,255,255,0.2); padding-bottom: 4px;">Target Behavior</h4>
                            <p>${safeDisplay(result.target_behavior, 'No significant changes.')}</p>
                        </div>
                    </div>
                `;

                resultsArea.innerHTML = html;

            } catch (error) {
                resultsArea.innerHTML = `
                    <div class="ai-error" style="text-align: center; margin-top: 50px;">
                        <strong>Analysis Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Analyze`;
            }
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        // Close username modal
        document.getElementById('username-modal-close').addEventListener('click', closeUsernameModal);
        document.getElementById('username-modal').addEventListener('click', (e) => {
            if (e.target.id === 'username-modal') {
                closeUsernameModal();
            }
        });

        document.getElementById('date-picker').addEventListener('change', handleDateChange);

        // AI Modal Controls
        const aiModal = document.getElementById('ai-modal');

        document.getElementById('ai-panel-open-btn').addEventListener('click', () => {
            aiModal.style.display = 'flex';
        });

        document.getElementById('ai-modal-close').addEventListener('click', () => {
            aiModal.style.display = 'none';
        });

        aiModal.addEventListener('click', (e) => {
            if (e.target === aiModal) aiModal.style.display = 'none';
        });

        document.getElementById('ai-compare-btn').addEventListener('click', compareWithAI);

        // ========================================
        // INITIALIZATION
        // ========================================
        window.addEventListener('load', () => {
            // Set max date for date picker to today
            const today = getTodayDate();
            document.querySelectorAll('#date-picker').forEach(picker => {
                picker.max = today;
                picker.value = today; // Set initial value to today
            });

            // Initialize AI date pickers
            const aiDate1 = document.getElementById('ai-date1');
            const aiDate2 = document.getElementById('ai-date2');
            if (aiDate1 && aiDate2) {
                aiDate1.max = today;
                aiDate2.max = today;
                // Set default dates (yesterday and today)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                aiDate1.value = yesterday.toISOString().split('T')[0];
                aiDate2.value = today;
            }

            // Setup mobile toggle
            setupMobileToggle();

            // Initialize map
            initMap();

            // Start in live mode
            switchToLiveMode();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>

</html>